define(["jQuery","loading","appRouter","globalize","fnchecked"],function($,loading,appRouter,globalize){"use strict";var currentUser;function loadUser(page,user){currentUser=user,ApiClient.getJSON(ApiClient.getUrl("Auth/Providers")).then(function(providers){!function(page,user,providers){1<providers.length&&!user.Policy.IsAdministrator?page.querySelector(".fldSelectLoginProvider").classList.remove("hide"):page.querySelector(".fldSelectLoginProvider").classList.add("hide");var currentProviderId=user.Policy.AuthenticationProviderId;page.querySelector(".selectLoginProvider").innerHTML=providers.map(function(provider){var selected=provider.Id===currentProviderId||providers.length<2?" selected":"";return'<option value="'+provider.Id+'"'+selected+">"+provider.Name+"</option>"})}(page,user,providers)}),ApiClient.getJSON(ApiClient.getUrl("Library/MediaFolders",{IsHidden:!1})).then(function(folders){!function(page,user,mediaFolders){ApiClient.getJSON(ApiClient.getUrl("Channels",{SupportsMediaDeletion:!0})).then(function(channelsResult){var i,length,folder,checkedAttribute,html="";for(i=0,length=mediaFolders.length;i<length;i++)folder=mediaFolders[i],checkedAttribute=user.Policy.EnableContentDeletion||-1!==user.Policy.EnableContentDeletionFromFolders.indexOf(folder.Id)?' checked="checked"':"",html+='<label><input type="checkbox" is="emby-checkbox" class="chkFolder" data-id="'+folder.Id+'" '+checkedAttribute+"><span>"+folder.Name+"</span></label>";for(i=0,length=channelsResult.Items.length;i<length;i++)folder=channelsResult.Items[i],checkedAttribute=user.Policy.EnableContentDeletion||-1!==user.Policy.EnableContentDeletionFromFolders.indexOf(folder.Id)?' checked="checked"':"",html+='<label><input type="checkbox" is="emby-checkbox" class="chkFolder" data-id="'+folder.Id+'" '+checkedAttribute+"><span>"+folder.Name+"</span></label>";$(".deleteAccess",page).html(html).trigger("create"),$("#chkEnableDeleteAllFolders",page).checked(user.Policy.EnableContentDeletion).trigger("change")})}(page,user,folders.Items)}),user.Policy.IsDisabled?page.querySelector(".disabledUserBanner").classList.remove("hide"):page.querySelector(".disabledUserBanner").classList.add("hide"),$(".lnkEditUserPreferences",page).attr("href","usermenu/usermenu.html?userId="+user.Id),appRouter.setTitle(user.Name),page.querySelector(".username").innerHTML=user.Name,$("#txtUserName",page).val(user.Name),$("#txtConnectUserName",page).val(currentUser.ConnectUserName),$("#chkIsAdmin",page).checked(user.Policy.IsAdministrator),$("#chkDisabled",page).checked(user.Policy.IsDisabled),$("#chkIsHidden",page).checked(user.Policy.IsHidden),$("#chkIsHiddenRemotely",page).checked(user.Policy.IsHiddenRemotely||!1),$("#chkRemoteControlSharedDevices",page).checked(user.Policy.EnableSharedDeviceControl),$("#chkEnableRemoteControlOtherUsers",page).checked(user.Policy.EnableRemoteControlOfOtherUsers),$("#chkEnableDownloading",page).checked(user.Policy.EnableContentDownloading),$("#chkEnableSubtitleDownloading",page).checked(user.Policy.EnableSubtitleDownloading||!1),$("#chkEnableSubtitleManagement",page).checked(user.Policy.EnableSubtitleManagement||!1),$("#chkManageLiveTv",page).checked(user.Policy.EnableLiveTvManagement),$("#chkEnableLiveTvAccess",page).checked(user.Policy.EnableLiveTvAccess),$("#chkEnableMediaPlayback",page).checked(user.Policy.EnableMediaPlayback),$("#chkEnableAudioPlaybackTranscoding",page).checked(user.Policy.EnableAudioPlaybackTranscoding),$("#chkEnableVideoPlaybackTranscoding",page).checked(user.Policy.EnableVideoPlaybackTranscoding),$("#chkEnableVideoPlaybackRemuxing",page).checked(user.Policy.EnablePlaybackRemuxing),$("#chkRemoteAccess",page).checked(null==user.Policy.EnableRemoteAccess||user.Policy.EnableRemoteAccess),$("#chkAllowChangeProfile",page).checked(user.Policy.EnableUserPreferenceAccess),$("#chkEnableSyncTranscoding",page).checked(user.Policy.EnableSyncTranscoding),$("#chkEnableConversion",page).checked(user.Policy.EnableMediaConversion||!1),$("#chkEnableSharing",page).checked(user.Policy.EnablePublicSharing),$("#txtRemoteClientBitrateLimit",page).val(user.Policy.RemoteClientBitrateLimit/1e6||""),loading.hide()}function saveUser(user,page){user.Name=$("#txtUserName",page).val(),user.Policy.IsAdministrator=$("#chkIsAdmin",page).checked(),user.Policy.IsHidden=$("#chkIsHidden",page).checked(),user.Policy.IsHiddenRemotely=$("#chkIsHiddenRemotely",page).checked(),user.Policy.IsDisabled=$("#chkDisabled",page).checked(),user.Policy.EnableRemoteControlOfOtherUsers=$("#chkEnableRemoteControlOtherUsers",page).checked(),user.Policy.EnableLiveTvManagement=$("#chkManageLiveTv",page).checked(),user.Policy.EnableLiveTvAccess=$("#chkEnableLiveTvAccess",page).checked(),user.Policy.EnableSharedDeviceControl=$("#chkRemoteControlSharedDevices",page).checked(),user.Policy.EnableMediaPlayback=$("#chkEnableMediaPlayback",page).checked(),user.Policy.EnableAudioPlaybackTranscoding=$("#chkEnableAudioPlaybackTranscoding",page).checked(),user.Policy.EnableVideoPlaybackTranscoding=$("#chkEnableVideoPlaybackTranscoding",page).checked(),user.Policy.EnablePlaybackRemuxing=$("#chkEnableVideoPlaybackRemuxing",page).checked(),user.Policy.EnableSubtitleDownloading=$("#chkEnableSubtitleDownloading",page).checked(),user.Policy.EnableSubtitleManagement=$("#chkEnableSubtitleManagement",page).checked(),user.Policy.EnableContentDownloading=$("#chkEnableDownloading",page).checked(),user.Policy.EnableSyncTranscoding=$("#chkEnableSyncTranscoding",page).checked(),user.Policy.EnableMediaConversion=$("#chkEnableConversion",page).checked(),user.Policy.EnablePublicSharing=$("#chkEnableSharing",page).checked(),user.Policy.EnableRemoteAccess=$("#chkRemoteAccess",page).checked(),user.Policy.RemoteClientBitrateLimit=parseInt(1e6*parseFloat($("#txtRemoteClientBitrateLimit",page).val()||"0")),user.Policy.AuthenticationProviderId=page.querySelector(".selectLoginProvider").value,user.Policy.EnableUserPreferenceAccess=page.querySelector("#chkAllowChangeProfile").checked,user.Policy.EnableContentDeletion=$("#chkEnableDeleteAllFolders",page).checked(),user.Policy.EnableContentDeletionFromFolders=user.Policy.EnableContentDeletion?[]:$(".chkFolder",page).get().filter(function(c){return c.checked}).map(function(c){return c.getAttribute("data-id")}),ApiClient.updateUser(user).then(function(){ApiClient.updateUserPolicy(user.Id,user.Policy).then(function(){!function(page,user){loading.hide(),(currentUser.ConnectUserName||"")===$("#txtConnectUserName",page).val()?require(["toast"],function(toast){toast(globalize.translate("SettingsSaved"))}):require(["connectHelper"],function(connectHelper){connectHelper.updateUserLink(ApiClient,user,$("#txtConnectUserName",page).val()).then(function(){loadData(page)})})}(page,user)})})}function onSubmit(){var page=$(this).parents(".page")[0];return loading.show(),getUser().then(function(result){saveUser(result,page)}),!1}function getUser(){var userId=getParameterByName("userId");return ApiClient.getUser(userId)}function loadData(page){loading.show(),getUser().then(function(user){loadUser(page,user)})}$(document).on("pageinit","#editUserPage",function(){$(".editUserProfileForm").off("submit",onSubmit).on("submit",onSubmit),this.querySelector(".sharingHelp").innerHTML=globalize.translate("OptionAllowLinkSharingHelp",30);var page=this;$("#chkEnableDeleteAllFolders",this).on("change",function(){this.checked?$(".deleteAccess",page).hide():$(".deleteAccess",page).show()}),ApiClient.getServerConfiguration().then(function(config){config.EnableRemoteAccess?page.querySelector(".fldRemoteAccess").classList.remove("hide"):page.querySelector(".fldRemoteAccess").classList.add("hide")});for(var userId=getParameterByName("userId"),btns=page.querySelectorAll(".userEditTabButton"),i=0,length=btns.length;i<length;i++)btns[i].href=btns[i].getAttribute("data-href")+"?userId="+userId}).on("pagebeforeshow","#editUserPage",function(){loadData(this)})});
define(["loading","appRouter","globalize","dom","emby-linkbutton","emby-select"],function(loading,appRouter,globalize,dom){"use strict";function loadUser(page,params){var userid=params.userId;ApiClient.getUser(userid).then(function(user){ApiClient.getCurrentUser().then(function(loggedInUser){appRouter.setTitle(user.Name),page.querySelector(".username").innerHTML=user.Name;var btnResetPassword=page.querySelector("#btnResetPassword"),showLocalAccessSection=!1;user.HasConfiguredPassword?(user.Policy.IsAdministrator?btnResetPassword&&btnResetPassword.classList.add("hide"):btnResetPassword&&btnResetPassword.classList.remove("hide"),page.querySelector("#fldCurrentPassword").classList.remove("hide"),showLocalAccessSection=!0):(btnResetPassword&&btnResetPassword.classList.add("hide"),page.querySelector("#fldCurrentPassword").classList.add("hide")),loggedInUser.Policy.IsAdministrator||user.Policy.EnableUserPreferenceAccess?page.querySelector(".passwordSection").classList.remove("hide"):page.querySelector(".passwordSection").classList.add("hide"),showLocalAccessSection&&(loggedInUser.Policy.IsAdministrator||user.Policy.EnableUserPreferenceAccess)?page.querySelector(".localAccessSection").classList.remove("hide"):page.querySelector(".localAccessSection").classList.add("hide"),page.querySelector("#txtInNetworkPassword").value="",user.Configuration.EnableLocalPassword?user.HasConfiguredEasyPassword?page.querySelector("#selectInNetworkPasswordMode").value="pin":page.querySelector("#selectInNetworkPasswordMode").value="nopassword":page.querySelector("#selectInNetworkPasswordMode").value="password",onInNetworkPasswordModeChange.call(page.querySelector("#selectInNetworkPasswordMode"))})}),page.querySelector("#txtCurrentPassword").value="",page.querySelector("#txtNewPassword").value="",page.querySelector("#txtNewPasswordConfirm").value=""}function onInNetworkPasswordModeChange(e){var form=dom.parentWithTag(this,"FORM"),txtEasyPassword=form.querySelector("#txtInNetworkPassword");"pin"===this.value?(form.querySelector(".fldInNetworkPassword").classList.remove("hide"),txtEasyPassword.setAttribute("required","required")):(form.querySelector(".fldInNetworkPassword").classList.add("hide"),txtEasyPassword.removeAttribute("required"))}return function(view,params){function onLocalAccessSaved(){loading.hide(),require(["toast"],function(toast){toast(globalize.translate("MessageSettingsSaved"))}),loadUser(view,params)}view.querySelector(".updatePasswordForm").addEventListener("submit",function(e){return this.querySelector("#txtNewPassword").value!==this.querySelector("#txtNewPasswordConfirm").value?require(["alert"],function(alert){alert(globalize.translate("PasswordMatchError"))}):(loading.show(),function(){var userId=params.userId;ApiClient.getUser(userId).then(function(user){var currentPassword="";user.HasConfiguredPassword&&(currentPassword=view.querySelector("#txtCurrentPassword").value);var newPassword=view.querySelector("#txtNewPassword").value;ApiClient.updateUserPassword(userId,currentPassword,newPassword).then(function(){loading.hide(),require(["toast"],function(toast){toast(globalize.translate("PasswordSaved"))}),loadUser(view,params)},function(){loading.hide(),Dashboard.alert({title:globalize.translate("HeaderLoginFailure"),message:globalize.translate("MessageInvalidUser")})})})}()),e.preventDefault(),!1}),view.querySelector(".localAccessForm").addEventListener("submit",function(e){loading.show();var userId=params.userId,mode=view.querySelector("#selectInNetworkPasswordMode").value;return ApiClient.getUser(userId).then(function(user){user.Configuration.EnableLocalPassword="password"!==mode,ApiClient.updateUserConfiguration(user.Id,user.Configuration).then(function(){if("password"===mode)onLocalAccessSaved();else{var easyPw="nopassword"===mode?"":view.querySelector("#txtInNetworkPassword").value;ApiClient.updateEasyPassword(userId,easyPw).then(onLocalAccessSaved)}})}),e.preventDefault(),!1}),view.querySelector("#selectInNetworkPasswordMode").addEventListener("change",onInNetworkPasswordModeChange);var btnResetPassword=view.querySelector("#btnResetPassword");btnResetPassword&&btnResetPassword.addEventListener("click",function(){var msg=globalize.translate("PasswordResetConfirmation");require(["confirm"],function(confirm){confirm(msg,globalize.translate("PasswordResetHeader")).then(function(){var userId=params.userId;loading.show(),ApiClient.resetUserPassword(userId).then(function(){loading.hide(),Dashboard.alert({message:globalize.translate("PasswordResetComplete"),title:globalize.translate("PasswordResetHeader")}),loadUser(view,params)})})})}),view.addEventListener("viewshow",function(){loadUser(view,params)});for(var btns=view.querySelectorAll(".userEditTabButton"),i=0,length=btns.length;i<length;i++)btns[i].href=btns[i].getAttribute("data-href")+"?userId="+params.userId}});
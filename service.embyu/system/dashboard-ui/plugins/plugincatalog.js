define(["loading","layoutManager","mainTabsManager","globalize","cardStyle","emby-linkbutton","emby-checkbox","emby-select","emby-scroller","css!./plugincatalog"],function(loading,layoutManager,mainTabsManager,globalize){"use strict";var query={TargetSystems:"Server",IsAdult:!1};function reloadList(page){loading.show(),query.IsAppStoreSafe=!0;var promise1=ApiClient.getAvailablePlugins(query),promise2=ApiClient.getInstalledPlugins();Promise.all([promise1,promise2]).then(function(responses){populateList({catalogElement:page.querySelector("#pluginTiles"),noItemsElement:page.querySelector("#noPlugins"),availablePlugins:responses[0],installedPlugins:responses[1]})})}function populateList(options){!function(options){var availablePlugins=options.availablePlugins,installedPlugins=options.installedPlugins,allPlugins=availablePlugins.filter(function(p){return p.category=p.category||"General",p.categoryDisplayName=function(category){category.replace(" ","").replace(" ","");"Channel"===category?category="Channels":"Theme"===category?category="Themes":"LiveTV"===category?category="HeaderLiveTV":"ScreenSaver"===category&&(category="HeaderScreenSavers");return globalize.translate(category)}(p.category),(!options.categories||-1!==options.categories.indexOf(p.category))&&((!options.targetSystem||p.targetSystem===options.targetSystem)&&"UserInstalled"===p.type)});availablePlugins=allPlugins.sort(function(a,b){var aName=a.category,bName=b.category;return bName<aName?1:aName<bName?-1:(aName=a.name,(bName=b.name)<aName?1:aName<bName?-1:0)});var i,length,plugin,currentCategory,html="",enableScrollX=!options.categories&&layoutManager.mobile;if(!options.categories){currentCategory=globalize.translate("HeaderTopPlugins"),html+='<div class="verticalSection">',html+='<h2 class="sectionTitle sectionTitle-cards padded-left padded-right">'+currentCategory+"</h2>";var topPlugins=allPlugins.slice(0).sort(function(a,b){if(a.installs>b.installs)return-1;if(b.installs>a.installs)return 1;var aName=a.name,bName=b.name;return bName<aName?1:aName<bName?-1:0}).filter(isUserInstalledPlugin);html+=enableScrollX?'<div is="emby-scroller" data-mousewheel="false" data-centerfocus="true" class="padded-top-focusscale padded-bottom-focusscale padded-left padded-right"><div is="emby-itemscontainer" data-multiselect="false" class="itemsContainer scrollSlider focuscontainer-x">':'<div class="itemsContainer vertical-wrap padded-left padded-right">';var limit=1920<=screen.availWidth?15:12;for(i=0,length=Math.min(topPlugins.length,limit);i<length;i++)html+=getPluginHtml(topPlugins[i],options,installedPlugins,enableScrollX);enableScrollX&&(html+="</div>"),html+="</div>",html+="</div>"}var hasOpenTag=!1;currentCategory=null,!1===options.showCategory&&(html+=enableScrollX?'<div is="emby-scroller" data-mousewheel="false" data-centerfocus="true" class="padded-top-focusscale padded-bottom-focusscale padded-left padded-right"><div is="emby-itemscontainer" data-multiselect="false" class="itemsContainer scrollSlider focuscontainer-x">':'<div class="itemsContainer vertical-wrap">',hasOpenTag=!0);for(i=0,length=availablePlugins.length;i<length;i++){var category=(plugin=availablePlugins[i]).categoryDisplayName;category!==currentCategory&&(!1!==options.showCategory&&(currentCategory&&(hasOpenTag=!1,enableScrollX&&(html+="</div>"),html+="</div>",html+="</div>"),html+='<div class="verticalSection">',html+='<h2 class="sectionTitle sectionTitle-cards padded-left padded-right">'+category+"</h2>",html+=enableScrollX?'<div is="emby-scroller" data-mousewheel="false" data-centerfocus="true" class="padded-top-focusscale padded-bottom-focusscale padded-left padded-right"><div is="emby-itemscontainer" data-multiselect="false" class="itemsContainer scrollSlider focuscontainer-x">':'<div class="itemsContainer vertical-wrap  padded-left padded-right">',hasOpenTag=!0),currentCategory=category),html+=getPluginHtml(plugin,options,installedPlugins,enableScrollX)}hasOpenTag&&(enableScrollX&&(html+="</div>"),html+="</div>",html+="</div>");!availablePlugins.length&&options.noItemsElement&&options.noItemsElement.classList.add("hide");options.catalogElement.innerHTML=html,loading.hide()}(options)}function isUserInstalledPlugin(plugin){return-1===["02528C96-F727-44D7-BE87-9EEF040758C3","0277E613-3EC0-4360-A3DE-F8AF0AABB5E9","4DCB591C-0FA2-4C5D-A7E5-DABE37164C8B","18CFFD2C-74F5-4EDE-8DAD-BE339443AFE4","C25B3C85-1880-4827-9C72-0FA74314F428","8C6DDB20-18B1-4131-9285-796179A71C0F","96FA50A4-69CE-42AC-B6A3-EF6B3388CCB7"].indexOf(plugin.guid)}function getPluginHtml(plugin,options,installedPlugins,enableScrollX){var html="",href=plugin.externalUrl?plugin.externalUrl:"plugins/addplugin.html?name="+encodeURIComponent(plugin.name)+"&guid="+plugin.guid;options.context&&(href+="&context="+options.context),html+="<div class='card "+(enableScrollX?"overflowSmallBackdropCard":"backdropCard")+"'>",html+='<div class="cardBox">',html+='<div class="cardScalable">',html+='<div class="cardPadder cardPadder-backdrop"></div>',html+='<a class="cardContent cardImageContainer cardContent-shadow" is="emby-linkbutton" href="'+href+'"'+(plugin.externalUrl?' target="_blank"':"")+">",plugin.thumbImage?(html+='<div class="cardImage coveredImage" style="background-image:url(\''+plugin.thumbImage+"');\">",html+="</div>"):html+='<i class="cardImageIcon md-icon">&#xE2C7;</i>',plugin.isPremium&&(0<plugin.price?html+="<div class='premiumBanner'><img class='premiumBanner-img' src='css/images/supporter/premiumflag.png' /></div>":html+="<div class='premiumBanner'><img class='premiumBanner-img' src='css/images/supporter/supporterflag.png' /></div>"),html+="</a>",html+="</div>",html+='<div class="cardFooter">',html+="<div class='cardText cardTextCentered'>",html+=plugin.name,html+="</div>";var installedPlugin=plugin.isApp?null:installedPlugins.filter(function(ip){return(ip.Id||"").toLowerCase()===(plugin.guid||"").toLowerCase()})[0];return html+="<div class='cardText cardText-secondary cardTextCentered'>",html+=installedPlugin?globalize.translate("LabelVersionInstalled").replace("{0}",installedPlugin.Version):"&nbsp;",html+="</div>",html+="</div>",html+="</div>",html+="</div>"}function getTabs(){return[{href:"plugins/plugins.html",name:globalize.translate("TabMyPlugins")},{href:"plugins/plugincatalog.html",name:globalize.translate("TabCatalog")}]}function PluginCatalog(view,params){view.querySelector("#selectSystem").addEventListener("change",function(){query.TargetSystems=this.value,reloadList(view)}),view.addEventListener("viewshow",function(){mainTabsManager.setTabs(this,1,getTabs),reloadList(this)})}return PluginCatalog.renderCatalog=populateList,PluginCatalog});
define(["apphost","userSettings","browser","events","pluginManager","backdrop","globalize","require","appSettings"],function(appHost,userSettings,browser,events,pluginManager,backdrop,globalize,require,appSettings){"use strict";var currentSkin,themeStyleElement,currentThemeId,currentThemeSettings;function loadSkin(id){var newSkin=pluginManager.plugins().filter(function(p){return p.id===id})[0];if(newSkin=newSkin||pluginManager.plugins().filter(function(p){return"defaultskin"===p.id})[0],currentSkin&&currentSkin.id===newSkin.id)return Promise.resolve(currentSkin);var deps=newSkin.getDependencies();return console.log("Loading skin dependencies"),require(deps).then(function(){console.log("Skin dependencies loaded");var strings=newSkin.getTranslations?newSkin.getTranslations():[];return globalize.loadStrings({name:newSkin.id,strings:strings}).then(function(){return(currentSkin=newSkin).load(),newSkin})})}function loadUserSkin(options){loadSkin(userSettings.get("skin",!1)||"defaultskin").then(function(skin){(options=options||{}).start?Emby.Page.invokeShortcut(options.start):Emby.Page.goHome()})}events.on(userSettings,"change",function(e,name){"skin"!==name&&"language"!==name||loadUserSkin()});var skinManager={getCurrentSkin:function(){return currentSkin},loadSkin:loadSkin,loadUserSkin:loadUserSkin,getThemes:function(){return currentSkin.getThemes?currentSkin.getThemes():[]},mapRoute:function(route){return currentSkin?pluginManager.mapRoute(currentSkin,route):route}};function onRegistrationSuccess(){appSettings.set("appthemesregistered","true")}function onRegistrationFailure(){appSettings.set("appthemesregistered","false")}function getThemeStylesheetInfo(id,requiresRegistration,isDefaultProperty){for(var defaultTheme,selectedTheme,themes=skinManager.getThemes(),i=0,length=themes.length;i<length;i++){var theme=themes[i];theme[isDefaultProperty]&&(defaultTheme=theme),id===theme.id&&(selectedTheme=theme)}(selectedTheme=selectedTheme||defaultTheme).id!==defaultTheme.id&&requiresRegistration&&(require(["registrationServices"]).then(function(deps){deps[0].validateFeature("themes",{showDialog:!1}).then(onRegistrationSuccess,onRegistrationFailure)}),"false"===appSettings.get("appthemesregistered"))&&(selectedTheme=defaultTheme);return{themeSettingsPath:"text!./themes/"+selectedTheme.id+"/theme.json",stylesheetPath:require.toUrl("bower_components/emby-webcomponents/themes/"+selectedTheme.id+"/theme.css"),themeId:selectedTheme.id}}var themeResources={};var currentSound,lastSound=0;function onViewBeforeShow(e){e.detail&&"video-osd"===e.detail.type||(themeResources.backdrop&&backdrop.setBackdrop(themeResources.backdrop),!browser.mobile&&userSettings.enableThemeSongs()&&3e4<(new Date).getTime()-lastSound&&themeResources.effect&&function(path,volume){lastSound=(new Date).getTime(),require(["howler"],function(howler){try{var sound=new Howl({src:[path],volume:volume||.1});sound.play(),currentSound=sound}catch(err){console.log("Error playing sound: "+err)}})}(themeResources.effect))}return skinManager.setTheme=function(id,context){return new Promise(function(resolve,reject){var requiresRegistration=!0;if("serverdashboard"!==context){var newId=function(id){if(!userSettings.enableSeasonalThemes())return id;var date=new Date,month=date.getMonth(),day=date.getDate();return 9===month&&31<=day?"halloween":id}(id);newId!==id&&(requiresRegistration=!1),id=newId}if("auto"===id&&appHost.getPreferredTheme&&(id=appHost.getPreferredTheme()||"dark",requiresRegistration=!1),currentThemeId&&currentThemeId===id)resolve();else{var info=getThemeStylesheetInfo(id,requiresRegistration,"serverdashboard"===context?"isDefaultServerDashboard":"isDefault");if(currentThemeId&&currentThemeId===info.themeId)resolve();else{var linkUrl=info.stylesheetPath;!function(){var elem=themeStyleElement;elem&&(elem.parentNode.removeChild(elem),currentThemeSettings=currentThemeId=themeStyleElement=null)}();var link=document.createElement("link");link.setAttribute("rel","stylesheet"),link.setAttribute("type","text/css"),link.onload=function(){!function(themeInfo){document.documentElement.classList.remove("preload"),require([themeInfo.themeSettingsPath],function(themeSettingsJson){currentThemeSettings=JSON.parse(themeSettingsJson);try{appHost.setTheme(currentThemeSettings)}catch(err){console.log("Error setting theme color: "+err)}})}(info),resolve()},link.setAttribute("href",linkUrl),document.head.appendChild(link),themeStyleElement=link,currentThemeId=info.themeId,function(id){lastSound=0,currentSound&&(currentSound.stop(),currentSound=null),backdrop.clear(),themeResources="halloween"!==id?{}:{themeSong:"https://github.com/MediaBrowser/Emby.Resources/raw/master/themes/halloween/monsterparadefade.mp3",effect:"https://github.com/MediaBrowser/Emby.Resources/raw/master/themes/halloween/howl.wav",backdrop:"https://github.com/MediaBrowser/Emby.Resources/raw/master/themes/halloween/bg.jpg"}}(info.themeId),onViewBeforeShow({})}}})},document.addEventListener("viewshow",onViewBeforeShow),skinManager});
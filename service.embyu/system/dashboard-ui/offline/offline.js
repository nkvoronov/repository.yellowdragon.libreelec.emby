define(["globalize","connectionManager","focusManager","cardBuilder","emby-itemscontainer","flexStyles","scrollStyles"],function(globalize,connectionManager,focusManager,cardBuilder){"use strict";return function(view,params){function mergeInto(list1,list2){for(var i=0,length=list2.length;i<length;i++)list1.push(list2[i])}function loadLatestSection(section){return function(type){var promises=connectionManager.getApiClients().map(function(apiClient){return apiClient.getLatestOfflineItems({MediaTypes:type,Limit:20})});return Promise.all(promises).then(function(responses){for(var items=[],i=0,length=responses.length;i<length;i++)mergeInto(items,responses[i]);return items})}(section.getAttribute("data-mediatype")).then(function(items){return cardBuilder.buildCards(items,{parentContainer:section,itemsContainer:section.querySelector(".itemsContainer"),shape:"backdrop",preferThumb:!0,inheritThumb:!1,showParentTitle:!0,showTitle:!0,centerText:!0,overlayText:!1}),Promise.resolve()},function(){return Promise.resolve()})}function loadServerFolders(parentElement,apiClient){return apiClient.getLocalFolders().then(function(items){return items.length&&function(parentElement,items,serverName){var html='<div class="verticalSection padded-left padded-right">';html+='<h2 class="sectionTitle">'+(serverName||"Server")+"</h2>";var id="section"+(new Date).getTime();html+='<div id="'+id+'" is="emby-itemscontainer" class="itemsContainer vertical-wrap"></div>',html+="</div>",parentElement.insertAdjacentHTML("beforeend",html),cardBuilder.buildCards(items,{itemsContainer:parentElement.querySelector("#"+id),shape:"backdrop",preferThumb:!0,showTitle:!0,centerText:!0,overlayText:!1})}(parentElement,items,apiClient.serverName()),Promise.resolve()})}function loadOfflineCategories(){var promises=[];return promises.push(function(){for(var sections=view.querySelectorAll(".latestSection"),promises=[],i=0,length=sections.length;i<length;i++)promises.push(loadLatestSection(sections[i]));return Promise.all(promises)}()),promises.push(function(){var offlineServers=view.querySelector(".offlineServers");offlineServers.innerHTML="";var promises=connectionManager.getApiClients().map(function(apiClient){return loadServerFolders(offlineServers,apiClient)});return Promise.all(promises)}()),Promise.all(promises)}function autoFocus(){focusManager.autoFocus(view)}view.addEventListener("viewshow",function(e){Emby.Page.setTitle(globalize.translate("Downloads")),e.detail.isRestored||loadOfflineCategories().then(autoFocus)})}});